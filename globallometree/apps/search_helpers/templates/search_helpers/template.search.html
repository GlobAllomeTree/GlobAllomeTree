{% extends 'base.html' %}
{% load staticfiles %}

{% block add_to_header %}

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <link rel="stylesheet" href="{% static 'search_helpers/css/search.css' %}" />
    <link rel="stylesheet" href="{% static 'css/typeahead.css' %}" />

{% endblock %}

{% block script %}
     <script type="text/javascript">
        //Declare a global namespace for our app
        window.app = {};
        //Add in some config to the app
        window.app.config = {
          //address of elastic search
          search_url : '{{search_url}}'
        }
    </script>


    <script src="{% static 'search_helpers/js/elastic.min.js' %}"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>

    <script src="{% static 'search_helpers/js/geohash.js' %}"></script>
    <script src="{% static 'search_helpers/js/typeahead.js' %}"></script>

    <script src="{% static 'search_helpers/js/search.js' %}"></script>
    <script src="{% static 'search_helpers/js/list.js' %}"></script>
    <script src="{% static 'search_helpers/js/map.js' %}"></script>

    <script src="{% static configuration_js_file %}"></script>


    {% if form_is_valid %}
        <script type="text/javascript"> 

            $(function() {
                //Get the search manager from allometric_equations/js/search.js
                var app = window.app;
                app.country_centroids = {{country_centroids|safe}};
                app.searchManager.setSearchDict({{search_dict|safe}});
                app.listController.init({
                    el : 'results-list-container'           
                });

                $('a[href="#results-map"]').on('shown.bs.tab', function(){
                    app.mapController.initOrShowMap({
                        el : 'map'            
                    });
                });    

                $('#export-form').submit(function(event) {
                    var query = app.searchManager.getQuery().from(0).size(1000);
                    query = JSON.stringify(query.toJSON());
                    $('#export-query').val(query);
                });

                var typeaheads = [
                    {
                        id : '#id_Species',
                        url : '/api/v1/species/?format=json&limit=10&unique_name=1&q=%QUERY',
                        displayKey : 'Species'
                    },
                    {
                        id : '#id_Genus',
                        url : '/api/v1/genera/?format=json&limit=10&unique_name=1&q=%QUERY',
                        displayKey : 'Genus'
                    }
                ];

                _.each(typeaheads, function(typeahead) {
                     var source = new Bloodhound({
                      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                      queryTokenizer: Bloodhound.tokenizers.whitespace,
                      remote: {
                        url: typeahead.url,
                        filter: function (data) {
                            return data.results
                        }
                      }
                    });

                    source.initialize();

                    $(typeahead.id).addClass('typeahead').typeahead(null, {
                      name: typeahead.displayKey,
                      hint: true,
                      displayKey: typeahead.displayKey,
                      highlight: true,
                      source: source.ttAdapter()
                    });
                });
            });
        </script>
    {% endif %}

{% endblock %}

{% block content %}

	<div id="equations_page">
	    

        <h3>{{ search_title }}</h3>
	    

        <div class="clearfix"></div>

        <!-- Search Form -->
        {% include form_template %}
		
    	{% if form_is_valid %}
            <div id="search-results">
        		<!-- Result Tabs -->
                <div style="float:right"> 
                    <form action='{% url 'equations_export' %}' id="export-form" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="query" id="export-query" />
                        <button type="submit" class="btn btn-default">
                            Export
                            <span class="glyphicon glyphicon-download"></span> 
                        </button>
                    <form>
                </div>
        		<ul id="results-tab" class="nav nav-tabs">
        			<li class="active">
        				<a href="#results-list" data-toggle="tab"><span class="glyphicon glyphicon-list"></span> Results List</a>
        			</li>
        			<li>
        				<a id="list-tab" href="#results-map" data-toggle="tab"><span class="glyphicon glyphicon-globe"></span> Map View</a>
        			</li>
                    <li>
                        <a href="#search-summary" data-toggle="tab"><span class="glyphicon  glyphicon-stats"></span> Search  Summary</a>
                    </li>
        		</ul>
        		
        		<div class="tab-content">
        			<div class="tab-pane active" id="results-list">
        			     <div id="results-list-container"></div>
        			</div>
        			
        			<div class="tab-pane" id="results-map">
        				<div id="map"></div>
        			</div>
                    <div class="tab-pane" id="search-summary">
                        {% include 'search_helpers/search_summary.html'%}
                    </div>
                </div>
        	</div>	
        {% else %}
            <h3> Invalid Search - Please revise the form for any errors</h3>
    	{% endif %}
	    
    </div>

{% endblock %}